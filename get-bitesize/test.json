{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::bitesize-dev/us-west-2/ubathsu/cacerts/*/ca.pem"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListObjects",
                "s3:ListBucket",
                "s3:GetObjectVersion",
                "s3:PutObject",
                "s3:GetBucketLocation"
            ],
            "Resource": [
                "arn:aws:s3:::bitesize-dev",
                "arn:aws:s3:::bitesize-dev/us-west-2/ubathsu/",
                "arn:aws:s3:::bitesize-dev/us-west-2/ubathsu/files/stackstorm",
                "arn:aws:s3:::bitesize-dev/us-west-2/ubathsu/files/stackstorm/*",
                "arn:aws:s3:::bitesize-dev/us-west-2/ubathsu/backups/stackstorm",
                "arn:aws:s3:::bitesize-dev/us-west-2/ubathsu/backups/stackstorm/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "ec2:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "cloudformation:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "iam:CreateRole",
                "iam:ListGroups",
                "iam:ListUsers",
                "iam:ListRoles",
                "iam:ListInstanceProfiles",
                "iam:ListPolicies",
                "iam:ListRolePolicies",
                "iam:GetRolePolicy",
                "iam:PutRolePolicy",
                "iam:PassRole",
                "iam:CreateInstanceProfile",
                "iam:CreatePolicy",
                "iam:AttachRolePolicy",
                "iam:DeleteInstanceProfile",
                "iam:AddRoleToInstanceProfile",
                "iam:ListInstanceProfilesForRole",
                "iam:RemoveRoleFromInstanceProfile",
                "iam:DeleteRolePolicy",
                "iam:DeleteRole"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "rds:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "kms:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "es:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "sns:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "elasticache:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "route53:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "ses:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "elasticloadbalancing:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "autoscaling:*"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "ssm:PutParameter",
                "ssm:AddTagsToResource",
                "ssm:GetParameters",
                "ssm:GetParameter"
            ],
            "Resource": [
                "arn:aws:ssm:*:*:parameter/*/database/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "ssm:SendCommand"
            ],
            "Resource": [
                "arn:aws:ec2:*:*:instance/*"
            ],
            "Condition": {
                "StringEquals": {
                    "ssm:resourceTag/Enable_SSM_Send_Command": [
                        "Yes"
                    ],
                    "ssm:resourceTag/DB_system": [
                        "couchbase",
                        "couchb",
                        "cb"
                    ]
                }
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "ssm:GetCommandInvocation"
            ],
            "Resource": [
                "arn:aws:ssm:*:*:*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "ssm:SendCommand"
            ],
            "Resource": [
                "arn:aws:ssm:*:*:document/couchbase-get-cluster-ip",
                "arn:aws:ssm:*:*:document/couchbase-server-remove"
            ]
        }
    ]
}


--- ===========================

{
    "Effect":"Allow",
    "Action":[
       "ssm:SendCommand"
    ],
    "Resource":"*",
    "Condition":{
       "StringLike":{
          "ssm:resourceTag/Deployment_name":[
             "cbtest17"
          ]
       }
    }
 },
 {
    "Effect":"Allow",
    "Action":[
       "ssm:SendCommand"
    ],
    "Resource":[
       "arn:aws:ssm:us-west-2:602604727914:document/couchbase-get-cluster-ip"
       "arn:aws:ssm:us-west-2::document/couchbase-*",
       "arn:aws:ssm:us-west-2::document/couchbase-*"
    ]
 },
 {
    "Effect":"Allow",
    "Action":[
       "ssm:UpdateInstanceInformation",
       "ssm:ListCommands",
       "ssm:ListCommandInvocations",
       "ssm:GetDocument"
    ],
    "Resource":"*"
 }



 policy_document: <% '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["autoscaling:Describe*","ec2:Describe*","elasticfilesystem:Describe*","logs:DescribeResourcePolicies","ec2messages:*"],"Resource":"*"},{"Effect":"Allow","Action":["ssm:GetParameter"],"Resource":"arn:aws:ssm:' + $.region + ':' + $.account_id + ':parameter/*/database/couchbase/*"},{"Effect":"Allow","Action":["ssm:*"],"Resource":"arn:aws:ssm:' + $.region + ':' + $.account_id + ':instance/*","Condition":{"StringEquals":{"ssm:resourceTag/DB_system":["' + $.database_system + '"],"ssm:resourceTag/Deployment_name":["' + $.deployment_name + '"]}}},{"Effect":"Allow","Action":["s3:PutObject","s3:GetObject"],"Resource":["arn:aws:s3:::' + $.s3_bucket_name + '/*"]}]}' %>



  couchbase-cli user-manage -c {{ClusterIpAddress}} -u Administrator \
 -p {{AdminPassword}} --set --rbac-username {{rbac_username}} --rbac-password {{rbac_password}} \
 --rbac-name "John Doe" --roles {{roles}} \
 --auth-domain local


couchbase-cli user-manage -c 10.1.33.23:8091 -u Administrator -p 4b920733b92b4ec4b51e8414 \
 --set --rbac-username susanthab --rbac-password susa123 --auth-domain local --roles bucket_admin[*]
 
 couchbase-cli user-manage -c 10.1.36.45:8091 -u Administrator -p e71102be0dc04e009bc237d3 --list



 create_rbac_user:
 action: aws_ssm.send_command
 input:
   InstanceIds:
     - <% $.instance_id %>
   DocumentName: "db-ubathsu-dev-couchbase-create-user"
   Comment: "Create Bucket Admin"
   Parameters:
     "AdminPassword":
        - <% $.username %>
     "ClusterIpAddress":
        - <% $.ip_address %>
     "RbacUsername":
        - 
     "RbacPassword":
        - <% $.password %>
     "Roles":
        - 'bucket_admin[*]'
 publish:
   command_id: <% task(create_rbac_user).result.result.Command.CommandId %>
 retry:
   count: 20
   delay: 60
   continue-on: <% task(create_rbac_user).result.result.Command.Status = 'Success' %>
 on-success:
   - update_consul_user